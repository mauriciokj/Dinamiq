#!/usr/bin/env bash

# Script de desenvolvimento para DinamiQ
# Facilita o gerenciamento dos projetos frontend e backend

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# FunÃ§Ã£o para mostrar ajuda
show_help() {
    echo -e "${BLUE}ğŸš€ DinamiQ - Script de Desenvolvimento${NC}"
    echo -e "${BLUE}=====================================${NC}"
    echo ""
    echo "Uso: $0 [comando]"
    echo ""
    echo "Comandos disponÃ­veis:"
    echo -e "  ${GREEN}start${NC}           - Inicia todos os servidores (backend + frontend)"
    echo -e "  ${GREEN}backend${NC}         - Inicia apenas o servidor backend (Rails)"
    echo -e "  ${GREEN}frontend${NC}        - Inicia apenas o servidor frontend (React)"
    echo -e "  ${GREEN}install${NC}         - Instala dependÃªncias do frontend"
    echo -e "  ${GREEN}info${NC}            - Mostra informaÃ§Ãµes dos projetos"
    echo -e "  ${GREEN}setup${NC}           - ConfiguraÃ§Ã£o inicial dos projetos"
    echo -e "  ${GREEN}test${NC}            - Executa testes do backend"
    echo -e "  ${GREEN}console${NC}         - Abre console Rails"
    echo -e "  ${GREEN}logs${NC}            - Mostra logs do servidor Rails"
    echo -e "  ${GREEN}help${NC}            - Mostra esta ajuda"
    echo ""
    echo "Exemplos:"
    echo "  $0 start     # Inicia desenvolvimento completo"
    echo "  $0 backend   # Apenas backend"
    echo "  $0 frontend  # Apenas frontend"
    echo ""
}

# FunÃ§Ã£o para verificar se estamos no diretÃ³rio correto
check_directory() {
    if [[ ! -f "Gemfile" ]] || [[ ! -f "config/application.rb" ]]; then
        echo -e "${RED}âŒ Erro: Execute este script no diretÃ³rio raiz do projeto Rails${NC}"
        exit 1
    fi
}

# FunÃ§Ã£o para limpar processos em portas especÃ­ficas
kill_port_process() {
    local port=$1
    local process_name=$2
    
    if lsof -i :$port > /dev/null 2>&1; then
        echo -e "${YELLOW}ğŸ”„ Porta $port estÃ¡ em uso. Liberando...${NC}"
        local pid=$(lsof -ti :$port)
        if [[ -n "$pid" ]]; then
            kill $pid 2>/dev/null || true
            sleep 1
            echo -e "${GREEN}âœ… Porta $port liberada${NC}"
        fi
    fi
}

# FunÃ§Ã£o para verificar se o arquivo de configuraÃ§Ã£o existe
check_config() {
    if [[ ! -f "config/projects.yml" ]]; then
        echo -e "${RED}âŒ Erro: Arquivo config/projects.yml nÃ£o encontrado${NC}"
        echo -e "${YELLOW}ğŸ’¡ Execute: $0 setup para criar a configuraÃ§Ã£o inicial${NC}"
        exit 1
    fi
}

# FunÃ§Ã£o para setup inicial
setup_projects() {
    echo -e "${BLUE}ğŸ”§ ConfiguraÃ§Ã£o inicial dos projetos${NC}"
    echo ""
    
    # Verifica se o arquivo de configuraÃ§Ã£o jÃ¡ existe
    if [[ -f "config/projects.yml" ]]; then
        echo -e "${GREEN}âœ… Arquivo config/projects.yml jÃ¡ existe${NC}"
    else
        echo -e "${RED}âŒ Arquivo config/projects.yml nÃ£o encontrado${NC}"
        echo -e "${YELLOW}ğŸ’¡ Crie o arquivo manualmente ou use o template fornecido${NC}"
        exit 1
    fi
    
    # Verifica dependÃªncias do backend
    echo -e "${CYAN}ğŸ“¦ Verificando dependÃªncias do backend...${NC}"
    if ! command -v ruby &> /dev/null; then
        echo -e "${RED}âŒ Ruby nÃ£o estÃ¡ instalado${NC}"
        exit 1
    fi
    
    if ! command -v bundle &> /dev/null; then
        echo -e "${RED}âŒ Bundler nÃ£o estÃ¡ instalado. Execute: gem install bundler${NC}"
        exit 1
    fi
    
    # Instala gems se necessÃ¡rio
    if [[ ! -f "Gemfile.lock" ]] || [[ "Gemfile" -nt "Gemfile.lock" ]]; then
        echo -e "${YELLOW}ğŸ”„ Instalando gems...${NC}"
        bundle install
    fi
    
    # Verifica dependÃªncias do frontend
    echo -e "${CYAN}ğŸ“¦ Verificando dependÃªncias do frontend...${NC}"
    if ! command -v node &> /dev/null; then
        echo -e "${RED}âŒ Node.js nÃ£o estÃ¡ instalado${NC}"
        exit 1
    fi
    
    if ! command -v npm &> /dev/null; then
        echo -e "${RED}âŒ npm nÃ£o estÃ¡ instalado${NC}"
        exit 1
    fi
    
    # Verifica se o diretÃ³rio do frontend existe
    if [[ ! -d "../poll-front" ]]; then
        echo -e "${RED}âŒ DiretÃ³rio ../poll-front nÃ£o encontrado${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… Setup concluÃ­do com sucesso!${NC}"
}

# FunÃ§Ã£o para mostrar informaÃ§Ãµes dos projetos
show_info() {
    echo -e "${BLUE}ğŸ“Š DinamiQ - InformaÃ§Ãµes dos Projetos${NC}"
    echo -e "${BLUE}====================================${NC}"
    echo ""
    echo -e "${PURPLE}Backend (Rails):${NC}"
    echo -e "  ğŸ“ Porta: 3005"
    echo -e "  ğŸ“‚ Caminho: ."
    echo -e "  ğŸŒ URL: http://localhost:3005"
    echo -e "  ğŸ“ DescriÃ§Ã£o: API Rails para sistema de enquetes em tempo real"
    echo ""
    echo -e "${PURPLE}Frontend (React):${NC}"
    echo -e "  ğŸ“ Porta: 3009"
    echo -e "  ğŸ“‚ Caminho: ../poll-front"
    echo -e "  ğŸŒ URL: http://localhost:3009"
    echo -e "  ğŸ“ DescriÃ§Ã£o: Interface React para visualizaÃ§Ã£o e criaÃ§Ã£o de enquetes"
    echo ""
    echo -e "${PURPLE}WebSocket:${NC}"
    echo -e "  ğŸ”Œ URL: ws://localhost:3005/cable"
    echo ""
}

# FunÃ§Ã£o para iniciar o backend
start_backend() {
    echo -e "${BLUE}ğŸš€ Iniciando DinamiQ Backend (Rails)...${NC}"
    
    # Libera a porta se estiver ocupada
    kill_port_process 3005 "Rails"
    
    # Verifica se as gems estÃ£o instaladas
    if [[ ! -f "Gemfile.lock" ]]; then
        echo -e "${YELLOW}ğŸ”„ Instalando gems...${NC}"
        bundle install
    fi
    
    # Inicia o servidor Rails
    echo -e "${GREEN}âœ… Iniciando servidor Rails na porta 3005...${NC}"
    bundle exec rails server -p 3005
}

# FunÃ§Ã£o para iniciar o frontend
start_frontend() {
    echo -e "${BLUE}ğŸš€ Iniciando Poll-Front (React)...${NC}"
    
    # Verifica se o diretÃ³rio existe
    if [[ ! -d "../poll-front" ]]; then
        echo -e "${RED}âŒ DiretÃ³rio ../poll-front nÃ£o encontrado${NC}"
        exit 1
    fi
    
    # Libera a porta se estiver ocupada
    kill_port_process 3009 "React"
    
    # Muda para o diretÃ³rio do frontend
    cd ../poll-front
    
    # Verifica se as dependÃªncias estÃ£o instaladas
    if [[ ! -d "node_modules" ]]; then
        echo -e "${YELLOW}ğŸ”„ Instalando dependÃªncias npm...${NC}"
        npm install
    fi
    
    # Inicia o servidor de desenvolvimento
    echo -e "${GREEN}âœ… Iniciando servidor React na porta 3009...${NC}"
    npm run dev
}

# FunÃ§Ã£o para instalar dependÃªncias do frontend
install_frontend_deps() {
    echo -e "${BLUE}ğŸ“¦ Instalando dependÃªncias do frontend...${NC}"
    
    if [[ ! -d "../poll-front" ]]; then
        echo -e "${RED}âŒ DiretÃ³rio ../poll-front nÃ£o encontrado${NC}"
        exit 1
    fi
    
    cd ../poll-front
    npm install
    echo -e "${GREEN}âœ… DependÃªncias instaladas com sucesso!${NC}"
}

# FunÃ§Ã£o para iniciar todos os serviÃ§os
start_all() {
    echo -e "${BLUE}ğŸš€ Iniciando DinamiQ - Desenvolvimento Completo${NC}"
    echo -e "${BLUE}===============================================${NC}"
    echo ""
    
    # Verifica configuraÃ§Ã£o
    check_config
    
    echo -e "${CYAN}ğŸ“‹ Iniciando backend e frontend automaticamente...${NC}"
    echo -e "${YELLOW}ğŸ’¡ Use Ctrl+C para parar ambos os serviÃ§os${NC}"
    echo ""
    
    # Inicia o backend em background
    start_backend_background
    
    # Aguarda um pouco para o backend inicializar
    sleep 3
    
    # Inicia o frontend em primeiro plano
    start_frontend
}

# FunÃ§Ã£o para executar testes
run_tests() {
    echo -e "${BLUE}ğŸ§ª Executando testes do backend...${NC}"
    bundle exec rspec
}

# FunÃ§Ã£o para abrir console Rails
open_console() {
    echo -e "${BLUE}ğŸ’» Abrindo console Rails...${NC}"
    bundle exec rails console
}

# FunÃ§Ã£o para mostrar logs
show_logs() {
    echo -e "${BLUE}ğŸ“‹ Logs do servidor Rails...${NC}"
    tail -f log/development.log
}

# Verifica se estamos no diretÃ³rio correto
check_directory

# Processa argumentos da linha de comando
case "${1:-help}" in
    "start")
        start_all
        ;;
    "backend")
        start_backend
        ;;
    "frontend")
        start_frontend
        ;;
    "install")
        install_frontend_deps
        ;;
    "info")
        show_info
        ;;
    "setup")
        setup_projects
        ;;
    "test")
        run_tests
        ;;
    "console")
        open_console
        ;;
    "logs")
        show_logs
        ;;
    "help"|*)
        show_help
        ;;
esac
