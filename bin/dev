#!/usr/bin/env bash

# Script de desenvolvimento para DinamiQ
# Facilita o gerenciamento dos projetos frontend e backend

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Fun√ß√£o para mostrar ajuda
show_help() {
    echo -e "${BLUE}üöÄ DinamiQ - Script de Desenvolvimento${NC}"
    echo -e "${BLUE}=====================================${NC}"
    echo ""
    echo "Uso: $0 [comando]"
    echo ""
    echo "Comandos dispon√≠veis:"
    echo -e "  ${GREEN}start${NC}           - Inicia todos os servidores (backend + frontend)"
    echo -e "  ${GREEN}backend${NC}         - Inicia apenas o servidor backend (Rails)"
    echo -e "  ${GREEN}frontend${NC}        - Inicia apenas o servidor frontend (React)"
    echo -e "  ${GREEN}install${NC}         - Instala depend√™ncias do frontend"
    echo -e "  ${GREEN}info${NC}            - Mostra informa√ß√µes dos projetos"
    echo -e "  ${GREEN}setup${NC}           - Configura√ß√£o inicial dos projetos"
    echo -e "  ${GREEN}test${NC}            - Executa testes do backend"
    echo -e "  ${GREEN}console${NC}         - Abre console Rails"
    echo -e "  ${GREEN}logs${NC}            - Mostra logs do servidor Rails"
    echo -e "  ${GREEN}help${NC}            - Mostra esta ajuda"
    echo ""
    echo "Exemplos:"
    echo "  $0 start     # Inicia desenvolvimento completo"
    echo "  $0 backend   # Apenas backend"
    echo "  $0 frontend  # Apenas frontend"
    echo ""
}

# Fun√ß√£o para verificar se estamos no diret√≥rio correto
check_directory() {
    if [[ ! -f "Gemfile" ]] || [[ ! -f "config/application.rb" ]]; then
        echo -e "${RED}‚ùå Erro: Execute este script no diret√≥rio raiz do projeto Rails${NC}"
        exit 1
    fi
}

# Fun√ß√£o para limpar processos em portas espec√≠ficas
kill_port_process() {
    local port=$1
    local process_name=$2
    
    if lsof -i :$port > /dev/null 2>&1; then
        echo -e "${YELLOW}üîÑ Porta $port est√° em uso. Liberando...${NC}"
        local pid=$(lsof -ti :$port)
        if [[ -n "$pid" ]]; then
            kill $pid 2>/dev/null || true
            sleep 1
            echo -e "${GREEN}‚úÖ Porta $port liberada${NC}"
        fi
    fi
}

# Fun√ß√£o para verificar se o arquivo de configura√ß√£o existe
check_config() {
    if [[ ! -f "config/projects.yml" ]]; then
        echo -e "${RED}‚ùå Erro: Arquivo config/projects.yml n√£o encontrado${NC}"
        echo -e "${YELLOW}üí° Execute: $0 setup para criar a configura√ß√£o inicial${NC}"
        exit 1
    fi
}

# Fun√ß√£o para setup inicial
setup_projects() {
    echo -e "${BLUE}üîß Configura√ß√£o inicial dos projetos${NC}"
    echo ""
    
    # Verifica se o arquivo de configura√ß√£o j√° existe
    if [[ -f "config/projects.yml" ]]; then
        echo -e "${GREEN}‚úÖ Arquivo config/projects.yml j√° existe${NC}"
    else
        echo -e "${RED}‚ùå Arquivo config/projects.yml n√£o encontrado${NC}"
        echo -e "${YELLOW}üí° Crie o arquivo manualmente ou use o template fornecido${NC}"
        exit 1
    fi
    
    # Verifica depend√™ncias do backend
    echo -e "${CYAN}üì¶ Verificando depend√™ncias do backend...${NC}"
    if ! command -v ruby &> /dev/null; then
        echo -e "${RED}‚ùå Ruby n√£o est√° instalado${NC}"
        exit 1
    fi
    
    if ! command -v bundle &> /dev/null; then
        echo -e "${RED}‚ùå Bundler n√£o est√° instalado. Execute: gem install bundler${NC}"
        exit 1
    fi
    
    # Instala gems se necess√°rio
    if [[ ! -f "Gemfile.lock" ]] || [[ "Gemfile" -nt "Gemfile.lock" ]]; then
        echo -e "${YELLOW}üîÑ Instalando gems...${NC}"
        bundle install
    fi
    
    # Verifica depend√™ncias do frontend
    echo -e "${CYAN}üì¶ Verificando depend√™ncias do frontend...${NC}"
    if ! command -v node &> /dev/null; then
        echo -e "${RED}‚ùå Node.js n√£o est√° instalado${NC}"
        exit 1
    fi
    
    if ! command -v npm &> /dev/null; then
        echo -e "${RED}‚ùå npm n√£o est√° instalado${NC}"
        exit 1
    fi
    
    # Verifica se o diret√≥rio do frontend existe
    if [[ ! -d "../poll-front" ]]; then
        echo -e "${RED}‚ùå Diret√≥rio ../poll-front n√£o encontrado${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}‚úÖ Setup conclu√≠do com sucesso!${NC}"
}

# Fun√ß√£o para mostrar informa√ß√µes dos projetos
show_info() {
    echo -e "${BLUE}üìä DinamiQ - Informa√ß√µes dos Projetos${NC}"
    echo -e "${BLUE}====================================${NC}"
    echo ""
    echo -e "${PURPLE}Backend (Rails):${NC}"
    echo -e "  üìç Porta: 3005"
    echo -e "  üìÇ Caminho: ."
    echo -e "  üåê URL: http://localhost:3005"
    echo -e "  üìù Descri√ß√£o: API Rails para sistema de enquetes em tempo real"
    echo ""
    echo -e "${PURPLE}Frontend (React):${NC}"
    echo -e "  üìç Porta: 3009"
    echo -e "  üìÇ Caminho: ../poll-front"
    echo -e "  üåê URL: http://localhost:3009"
    echo -e "  üìù Descri√ß√£o: Interface React para visualiza√ß√£o e cria√ß√£o de enquetes"
    echo ""
    echo -e "${PURPLE}WebSocket:${NC}"
    echo -e "  üîå URL: ws://localhost:3005/cable"
    echo ""
}

# Fun√ß√£o para iniciar o backend
start_backend() {
    echo -e "${BLUE}üöÄ Iniciando DinamiQ Backend (Rails)...${NC}"
    
    # Libera a porta se estiver ocupada
    kill_port_process 3005 "Rails"
    
    # Verifica se as gems est√£o instaladas
    if [[ ! -f "Gemfile.lock" ]]; then
        echo -e "${YELLOW}üîÑ Instalando gems...${NC}"
        bundle install
    fi
    
    # Inicia o servidor Rails
    echo -e "${GREEN}‚úÖ Iniciando servidor Rails na porta 3005...${NC}"
    bundle exec rails server -p 3005
}

# Fun√ß√£o para iniciar o backend em background
start_backend_background() {
    echo -e "${BLUE}üöÄ Iniciando DinamiQ Backend (Rails) em background...${NC}"
    
    # Libera a porta se estiver ocupada
    kill_port_process 3005 "Rails"
    
    # Verifica se as gems est√£o instaladas
    if [[ ! -f "Gemfile.lock" ]]; then
        echo -e "${YELLOW}üîÑ Instalando gems...${NC}"
        bundle install
    fi
    
    # Inicia o servidor Rails em background
    echo -e "${GREEN}‚úÖ Iniciando servidor Rails na porta 3005 (background)...${NC}"
    bundle exec rails server -p 3005 > /dev/null 2>&1 &
    
    # Salva o PID do processo para poder mat√°-lo depois
    BACKEND_PID=$!
    echo -e "${CYAN}üìù Backend PID: $BACKEND_PID${NC}"
    
    # Fun√ß√£o para limpar processos ao sair
    cleanup() {
        echo -e "\n${YELLOW}üîÑ Parando servi√ßos...${NC}"
        if [[ -n "$BACKEND_PID" ]]; then
            kill $BACKEND_PID 2>/dev/null || true
            echo -e "${GREEN}‚úÖ Backend parado${NC}"
        fi
        kill_port_process 3005 "Rails"
        kill_port_process 3009 "React"
        exit 0
    }
    
    # Configura trap para limpar processos ao receber Ctrl+C
    trap cleanup SIGINT SIGTERM
}

# Fun√ß√£o para iniciar o frontend
start_frontend() {
    echo -e "${BLUE}üöÄ Iniciando Poll-Front (React)...${NC}"
    
    # Verifica se o diret√≥rio existe
    if [[ ! -d "../poll-front" ]]; then
        echo -e "${RED}‚ùå Diret√≥rio ../poll-front n√£o encontrado${NC}"
        exit 1
    fi
    
    # Libera a porta se estiver ocupada
    kill_port_process 3009 "React"
    
    # Muda para o diret√≥rio do frontend
    cd ../poll-front
    
    # Verifica se as depend√™ncias est√£o instaladas
    if [[ ! -d "node_modules" ]]; then
        echo -e "${YELLOW}üîÑ Instalando depend√™ncias npm...${NC}"
        npm install
    fi
    
    # Inicia o servidor de desenvolvimento
    echo -e "${GREEN}‚úÖ Iniciando servidor React na porta 3009...${NC}"
    
    # Se foi chamado pelo start_all, configura trap para limpeza
    if [[ "${CALLED_FROM_START_ALL}" == "true" ]]; then
        # Fun√ß√£o para limpar processos ao sair
        cleanup_frontend() {
            echo -e "\n${YELLOW}üîÑ Parando servi√ßos...${NC}"
            if [[ -n "$BACKEND_PID" ]]; then
                kill $BACKEND_PID 2>/dev/null || true
                echo -e "${GREEN}‚úÖ Backend parado${NC}"
            fi
            kill_port_process 3005 "Rails"
            kill_port_process 3009 "React"
            exit 0
        }
        
        # Configura trap para limpar processos ao receber Ctrl+C
        trap cleanup_frontend SIGINT SIGTERM
    fi
    
    npm run dev
}

# Fun√ß√£o para instalar depend√™ncias do frontend
install_frontend_deps() {
    echo -e "${BLUE}üì¶ Instalando depend√™ncias do frontend...${NC}"
    
    if [[ ! -d "../poll-front" ]]; then
        echo -e "${RED}‚ùå Diret√≥rio ../poll-front n√£o encontrado${NC}"
        exit 1
    fi
    
    cd ../poll-front
    npm install
    echo -e "${GREEN}‚úÖ Depend√™ncias instaladas com sucesso!${NC}"
}

# Fun√ß√£o para iniciar todos os servi√ßos
start_all() {
    echo -e "${BLUE}üöÄ Iniciando DinamiQ - Desenvolvimento Completo${NC}"
    echo -e "${BLUE}===============================================${NC}"
    echo ""
    
    # Verifica configura√ß√£o
    check_config
    
    echo -e "${CYAN}üìã Iniciando backend e frontend automaticamente...${NC}"
    echo -e "${YELLOW}üí° Use Ctrl+C para parar ambos os servi√ßos${NC}"
    echo ""
    
    # Define que foi chamado pelo start_all
    export CALLED_FROM_START_ALL="true"
    
    # Inicia o backend em background
    start_backend_background
    
    # Exporta o PID do backend para o frontend poder acessar
    export BACKEND_PID
    
    # Aguarda um pouco para o backend inicializar
    sleep 3
    
    # Inicia o frontend em primeiro plano
    start_frontend
}

# Fun√ß√£o para executar testes
run_tests() {
    echo -e "${BLUE}üß™ Executando testes do backend...${NC}"
    bundle exec rspec
}

# Fun√ß√£o para abrir console Rails
open_console() {
    echo -e "${BLUE}üíª Abrindo console Rails...${NC}"
    bundle exec rails console
}

# Fun√ß√£o para mostrar logs
show_logs() {
    echo -e "${BLUE}üìã Logs do servidor Rails...${NC}"
    tail -f log/development.log
}

# Verifica se estamos no diret√≥rio correto
check_directory

# Processa argumentos da linha de comando
case "${1:-help}" in
    "start")
        start_all
        ;;
    "backend")
        start_backend
        ;;
    "frontend")
        start_frontend
        ;;
    "install")
        install_frontend_deps
        ;;
    "info")
        show_info
        ;;
    "setup")
        setup_projects
        ;;
    "test")
        run_tests
        ;;
    "console")
        open_console
        ;;
    "logs")
        show_logs
        ;;
    "help"|*)
        show_help
        ;;
esac
